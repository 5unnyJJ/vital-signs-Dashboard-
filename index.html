<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ©Ÿæ§‹å¥åº·è³‡æ–™çœ‹æ¿</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&family=DM+Sans:ital,wght@0,300;0,400;0,500;0,600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --bg:           #edf1ee;
  --bg-alt:       #f4f7f5;
  --surface:      #ffffff;
  --surface-tint: #f0f6f2;
  --border:       #d4e3da;
  --border-light: #e8f0eb;

  --mint:         #7aaa96;
  --mint-mid:     #5d9180;
  --mint-dark:    #406b5c;
  --mint-light:   #dff0e8;
  --mint-xlight:  #f0f9f4;

  --text:         #243028;
  --text-mid:     #4a6358;
  --text-dim:     #85a098;
  --text-light:   #b8cdc5;

  --red:          #b85450;
  --red-light:    #faeeed;
  --orange:       #bf7a45;
  --orange-light: #faf0e5;
  --green:        #6b9e7a;
  --green-light:  #e8f4ec;

  --shadow-sm: 0 1px 3px rgba(50,80,65,.06), 0 0 0 1px rgba(50,80,65,.04);
  --shadow:    0 4px 16px rgba(50,80,65,.08), 0 0 0 1px rgba(50,80,65,.05);
  --shadow-md: 0 8px 32px rgba(50,80,65,.11), 0 0 0 1px rgba(50,80,65,.06);

  --radius:    18px;
  --radius-md: 12px;
  --radius-sm: 8px;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'Noto Sans TC', 'DM Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   LOGIN
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#login-screen {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  background:
    radial-gradient(ellipse at 25% 45%, rgba(122,170,150,.14) 0%, transparent 55%),
    radial-gradient(ellipse at 78% 65%, rgba(122,170,150,.08) 0%, transparent 50%),
    var(--bg);
}

.login-wrap {
  display: flex;
  background: var(--surface);
  border-radius: 24px;
  box-shadow: var(--shadow-md);
  overflow: hidden;
  width: 840px;
  max-width: 92vw;
}

.login-aside {
  width: 290px;
  flex-shrink: 0;
  background: linear-gradient(150deg, #6fa890 0%, #3d6b58 100%);
  padding: 52px 40px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.login-brand h1 {
  font-size: 22px;
  font-weight: 700;
  color: #fff;
  line-height: 1.35;
  letter-spacing: -.3px;
}
.login-brand p {
  font-size: 12px;
  color: rgba(255,255,255,.65);
  margin-top: 6px;
  letter-spacing: .5px;
  text-transform: uppercase;
}

.login-deco {
  font-size: 72px;
  opacity: .2;
  text-align: right;
  user-select: none;
  line-height: 1;
}

.login-form {
  flex: 1;
  padding: 52px 52px;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.login-form h2 {
  font-size: 22px;
  font-weight: 700;
  color: var(--text);
  letter-spacing: -.4px;
  margin-bottom: 6px;
}
.login-form .sub {
  font-size: 14px;
  color: var(--text-dim);
  margin-bottom: 36px;
}

.field {
  margin-bottom: 18px;
}
.field label {
  display: block;
  font-size: 11px;
  font-weight: 700;
  color: var(--text-mid);
  margin-bottom: 8px;
  text-transform: uppercase;
  letter-spacing: .6px;
}
.field input {
  width: 100%;
  padding: 13px 16px;
  background: var(--bg-alt);
  border: 1.5px solid var(--border);
  border-radius: var(--radius-md);
  color: var(--text);
  font-size: 14px;
  font-family: inherit;
  outline: none;
  transition: border-color .2s, box-shadow .2s, background .15s;
}
.field input:focus {
  border-color: var(--mint);
  background: #fff;
  box-shadow: 0 0 0 3px rgba(122,170,150,.18);
}

.remember-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: -4px;
  margin-bottom: 24px;
}
.remember-row input[type=checkbox] {
  width: 15px; height: 15px;
  accent-color: var(--mint);
  cursor: pointer;
}
.remember-row label {
  font-size: 13px;
  color: var(--text-dim);
  cursor: pointer;
}

.btn-login {
  width: 100%;
  padding: 14px;
  background: var(--mint);
  color: #fff;
  border: none;
  border-radius: var(--radius-md);
  font-size: 15px;
  font-weight: 600;
  font-family: inherit;
  cursor: pointer;
  transition: background .2s, transform .1s, box-shadow .2s;
  box-shadow: 0 4px 12px rgba(122,170,150,.35);
  letter-spacing: .2px;
}
.btn-login:hover { background: var(--mint-mid); }
.btn-login:active { transform: scale(.99); }
.btn-login:disabled { opacity: .5; cursor: not-allowed; box-shadow: none; }

.error-msg {
  background: var(--red-light);
  border: 1px solid rgba(184,84,80,.2);
  color: var(--red);
  padding: 10px 14px;
  border-radius: var(--radius-sm);
  font-size: 13px;
  margin-bottom: 16px;
  display: none;
}

@media (max-width: 620px) {
  .login-aside { display: none; }
  .login-form  { padding: 40px 28px; }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   TOPBAR
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#dashboard { display: none; }

.topbar {
  position: sticky;
  top: 0;
  z-index: 200;
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 64px;
  padding: 0 44px;
  background: rgba(255,255,255,.88);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--border-light);
}

.topbar-brand {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 15px;
  font-weight: 700;
  color: var(--mint-dark);
  letter-spacing: -.2px;
}
.topbar-brand .leaf { font-size: 18px; }

.topbar-right {
  display: flex;
  align-items: center;
  gap: 14px;
}

.user-chip {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 5px 14px 5px 6px;
  background: var(--mint-xlight);
  border: 1.5px solid var(--mint-light);
  border-radius: 40px;
}
.user-avatar {
  width: 30px; height: 30px;
  background: var(--mint);
  color: #fff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  font-weight: 700;
  flex-shrink: 0;
}
.user-chip span {
  font-size: 13px;
  color: var(--text-mid);
  font-weight: 500;
  max-width: 200px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.btn-logout {
  padding: 7px 16px;
  background: transparent;
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-dim);
  font-size: 13px;
  font-family: inherit;
  cursor: pointer;
  transition: all .2s;
}
.btn-logout:hover {
  border-color: var(--red);
  color: var(--red);
  background: var(--red-light);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   MAIN
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main {
  padding: 40px 44px;
  max-width: 1480px;
  margin: 0 auto;
}

.page-header { margin-bottom: 32px; }
.page-header h1 {
  font-size: 26px;
  font-weight: 700;
  letter-spacing: -.5px;
  color: var(--text);
  margin-bottom: 4px;
}
.page-header p { font-size: 14px; color: var(--text-dim); }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   TABS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 28px;
  flex-wrap: wrap;
}
.tab {
  display: flex;
  align-items: center;
  gap: 7px;
  padding: 10px 24px;
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: 40px;
  color: var(--text-dim);
  font-size: 14px;
  font-weight: 500;
  font-family: inherit;
  cursor: pointer;
  transition: all .2s;
  box-shadow: var(--shadow-sm);
}
.tab:hover {
  border-color: var(--mint);
  color: var(--mint-dark);
  background: var(--mint-xlight);
}
.tab.active {
  background: var(--mint);
  border-color: var(--mint);
  color: #fff;
  box-shadow: 0 3px 10px rgba(122,170,150,.35);
}
.tab-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  background: currentColor;
  opacity: .7;
  flex-shrink: 0;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   TOOLBAR
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toolbar {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 20px;
}
.count-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 7px 16px;
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  font-size: 13px;
  color: var(--text-mid);
  box-shadow: var(--shadow-sm);
}
.count-badge strong { color: var(--text); font-weight: 700; }

.btn-refresh {
  display: flex;
  align-items: center;
  gap: 7px;
  padding: 9px 20px;
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-mid);
  font-size: 13px;
  font-family: inherit;
  cursor: pointer;
  transition: all .2s;
  box-shadow: var(--shadow-sm);
}
.btn-refresh:hover {
  border-color: var(--mint);
  color: var(--mint-dark);
  background: var(--mint-xlight);
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   CONTENT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#table-content {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

/* â”€â”€â”€ Date Card â”€â”€â”€ */
.date-card {
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: var(--radius);
  overflow: hidden;
  box-shadow: var(--shadow-sm);
  transition: box-shadow .2s;
}
.date-card:hover { box-shadow: var(--shadow); }

.date-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 22px 28px;
  cursor: pointer;
  user-select: none;
  transition: background .15s;
}
.date-header:hover { background: var(--bg-alt); }

.date-header-left {
  display: flex;
  align-items: center;
  gap: 16px;
}
.date-icon {
  width: 44px; height: 44px;
  background: var(--mint-light);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  flex-shrink: 0;
}
.date-label {
  font-size: 17px;
  font-weight: 700;
  color: var(--text);
  letter-spacing: -.3px;
}
.date-meta {
  font-size: 13px;
  color: var(--text-dim);
  margin-top: 3px;
}

.date-chevron {
  width: 30px; height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  color: var(--text-light);
  transition: transform .25s ease, color .15s;
}
.date-card.open .date-chevron {
  transform: rotate(180deg);
  color: var(--mint);
}

.date-body {
  display: none;
  padding: 0 20px 20px;
  flex-direction: column;
  gap: 10px;
}
.date-card.open .date-body { display: flex; }

/* â”€â”€â”€ Hour Card â”€â”€â”€ */
.hour-card {
  background: var(--bg-alt);
  border: 1.5px solid var(--border-light);
  border-radius: var(--radius-md);
  overflow: hidden;
}

.hour-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 15px 20px;
  cursor: pointer;
  user-select: none;
  transition: background .15s;
}
.hour-header:hover { background: var(--mint-xlight); }

.hour-label {
  font-size: 14px;
  font-weight: 700;
  color: var(--text);
  font-feature-settings: 'tnum';
  flex-shrink: 0;
}
.hour-count {
  font-size: 12px;
  color: var(--text-dim);
  background: var(--surface);
  border: 1px solid var(--border);
  padding: 2px 10px;
  border-radius: 20px;
  flex-shrink: 0;
}
.hour-stats {
  display: flex;
  align-items: center;
  gap: 14px;
  flex: 1;
  flex-wrap: wrap;
}
.stat-chip {
  display: flex;
  align-items: center;
  gap: 5px;
  font-size: 12.5px;
  color: var(--text-mid);
}
.stat-chip .stat-icon { font-size: 13px; }
.stat-val {
  font-weight: 700;
  color: var(--text);
  font-feature-settings: 'tnum';
}
.stat-val.is-red    { color: var(--red); }
.stat-val.is-orange { color: var(--orange); }

.hour-chevron {
  width: 22px; height: 22px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--text-light);
  transition: transform .2s;
  flex-shrink: 0;
  margin-left: auto;
}
.hour-card.open .hour-chevron { transform: rotate(180deg); }

.hour-body {
  display: none;
  border-top: 1px solid var(--border-light);
}
.hour-card.open .hour-body { display: block; }

/* Sparkline row */
.sparkline-area {
  display: flex;
  align-items: center;
  gap: 32px;
  padding: 18px 22px 14px;
  background: var(--surface);
  border-bottom: 1px solid var(--border-light);
  overflow-x: auto;
}
.spark-item {
  display: flex;
  flex-direction: column;
  gap: 5px;
}
.spark-label {
  font-size: 11px;
  font-weight: 700;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: .6px;
}

/* â”€â”€â”€ Data Table â”€â”€â”€ */
.data-table-wrap {
  overflow-x: auto;
  background: var(--surface);
}
.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
  min-width: 920px;
}
.data-table thead th {
  padding: 13px 18px;
  text-align: left;
  font-weight: 700;
  font-size: 11px;
  color: var(--text-dim);
  text-transform: uppercase;
  letter-spacing: .7px;
  background: var(--bg-alt);
  border-bottom: 1px solid var(--border-light);
  white-space: nowrap;
}
.data-table tbody td {
  padding: 14px 18px;
  border-bottom: 1px solid var(--border-light);
  white-space: nowrap;
  vertical-align: middle;
}
.data-table tbody tr:hover td { background: var(--mint-xlight); }
.data-table tbody tr:last-child td { border-bottom: none; }

/* Value display */
.val-neutral {
  font-size: 13.5px;
  color: var(--text);
  font-feature-settings: 'tnum';
}
.val-dim { color: var(--text-light); }

.val-badge {
  display: inline-block;
  padding: 4px 11px;
  border-radius: 7px;
  font-size: 12.5px;
  font-weight: 700;
  font-feature-settings: 'tnum';
}
.val-green  { background: var(--green-light);  color: #3d7a50; }
.val-orange { background: var(--orange-light); color: #7a4a18; }
.val-red    { background: var(--red-light);    color: #8a2a26; }

/* â”€â”€â”€ States â”€â”€â”€ */
.state-card {
  background: var(--surface);
  border: 1.5px solid var(--border);
  border-radius: var(--radius);
  padding: 72px 32px;
  text-align: center;
  color: var(--text-dim);
  font-size: 15px;
  box-shadow: var(--shadow-sm);
}

.loading-spinner {
  display: inline-block;
  width: 18px; height: 18px;
  border: 2px solid var(--border);
  border-top-color: var(--mint);
  border-radius: 50%;
  animation: spin .7s linear infinite;
  margin-right: 8px;
  vertical-align: middle;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€â”€ Responsive â”€â”€â”€ */
@media (max-width: 800px) {
  .topbar { padding: 0 20px; }
  .main   { padding: 24px 16px; }
  .hour-stats { display: none; }
  .user-chip span { max-width: 120px; }
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="login-screen">
  <div class="login-wrap">

    <div class="login-aside">
      <div class="login-brand">
        <h1>æ©Ÿæ§‹å¥åº·<br>è³‡æ–™çœ‹æ¿</h1>
        <p>Healthcare Dashboard</p>
      </div>
      <div class="login-deco">ğŸŒ¿</div>
    </div>

    <div class="login-form">
      <h2>æ­¡è¿å›ä¾†</h2>
      <p class="sub">è«‹ä½¿ç”¨å·²æˆæ¬Šçš„å¸³è™Ÿç™»å…¥</p>

      <div class="error-msg" id="login-error"></div>

      <div class="field">
        <label>Email</label>
        <input type="email" id="email" placeholder="your@email.com" autocomplete="email">
      </div>
      <div class="field">
        <label>å¯†ç¢¼</label>
        <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
      </div>

      <div class="remember-row">
        <input type="checkbox" id="remember">
        <label for="remember">è¨˜ä½å¸³è™Ÿèˆ‡å¯†ç¢¼</label>
      </div>

      <button class="btn-login" id="btn-login" onclick="doLogin()">ç™»å…¥</button>
    </div>

  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="dashboard">

  <div class="topbar">
    <div class="topbar-brand">
      <span class="leaf">ğŸŒ¿</span> å¥åº·è³‡æ–™çœ‹æ¿
    </div>
    <div class="topbar-right">
      <div class="user-chip">
        <div class="user-avatar" id="user-avatar">?</div>
        <span id="user-email"></span>
      </div>
      <button class="btn-logout" onclick="doLogout()">ç™»å‡º</button>
    </div>
  </div>

  <div class="main">
    <div class="page-header">
      <h1 id="page-title">å¥åº·è³‡æ–™ç¸½è¦½</h1>
      <p id="page-sub">é¸æ“‡ä¸‹æ–¹è³‡æ–™è¡¨é–‹å§‹æŸ¥é–±</p>
    </div>

    <div class="tabs" id="tabs"></div>

    <div class="toolbar">
      <div class="count-badge" id="row-count" style="visibility:hidden">â€”</div>
      <button class="btn-refresh" onclick="loadCurrentTable()">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <polyline points="23 4 23 10 17 10"/>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
        </svg>
        é‡æ–°æ•´ç†
      </button>
    </div>

    <div id="table-content">
      <div class="state-card">è«‹é¸æ“‡è³‡æ–™è¡¨</div>
    </div>
  </div>

</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Supabase
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL      = 'https://lrrxswxvphoeyuvemvin.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxycnhzd3h2cGhvZXl1dmVtdmluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzMzU1NjksImV4cCI6MjA4MzkxMTU2OX0.54qS-CTVL9XeIbNO83r8spsRrk8woyBz3u-HoRdFxHs';
let sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Config
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ACCESS_MAP = {
  'dulancliniccloud@gmail.com': ['DC_data_base'],
  'ttricloudtest001@gmail.com': ['CY_data_base', 'YK_data_base'],
  'kingpig4628@gmail.com':      ['DC_data_base', 'CY_data_base', 'YK_data_base'],
  'zywu.1487@gmail.com':        ['DC_data_base', 'CY_data_base', 'YK_data_base'],
};

const TABLE_LABEL = {
  'DC_data_base': 'DC æ©Ÿæ§‹',
  'CY_data_base': 'CY æ©Ÿæ§‹',
  'YK_data_base': 'YK æ©Ÿæ§‹',
};

const COLUMNS = [
  { key: 'member_id',   label: 'æœƒå“¡ç·¨è™Ÿ',  badge: false },
  { key: 'date_minute', label: 'é‡æ¸¬æ™‚é–“',  badge: false },
  { key: 'heartbeat',   label: 'å¿ƒè·³',      badge: true  },
  { key: 'temp',        label: 'é«”æº«',      badge: true  },
  { key: 'breath',      label: 'å‘¼å¸',      badge: false },
  { key: 'sbp',         label: 'æ”¶ç¸®å£“',    badge: true  },
  { key: 'dbp',         label: 'èˆ’å¼µå£“',    badge: true  },
  { key: 'pulse',       label: 'è„ˆæ',      badge: false },
  { key: 'step',        label: 'æ­¥æ•¸',      badge: false },
  { key: 'calorie',     label: 'å¡è·¯é‡Œ',    badge: false },
  { key: 'action',      label: 'å‹•ä½œ',      badge: false },
  { key: 'received_at', label: 'æ¥æ”¶æ™‚é–“',  badge: false },
];

let currentTable = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Anomaly
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function anomalyLevel(key, raw) {
  if (raw === null || raw === undefined || raw === '') return 'neutral';
  const v = parseFloat(raw);
  if (isNaN(v)) return 'neutral';
  switch (key) {
    case 'sbp':
      if (v >= 160 || v < 80)  return 'red';
      if (v >= 140 || v < 90)  return 'orange';
      return 'green';
    case 'dbp':
      if (v >= 100 || v < 55)  return 'red';
      if (v >= 90  || v < 60)  return 'orange';
      return 'green';
    case 'heartbeat':
      if (v > 120 || v < 50)   return 'red';
      if (v > 100 || v < 60)   return 'orange';
      return 'green';
    case 'temp':
      if (v > 38.0 || v < 36.0) return 'red';
      if (v > 37.2)              return 'orange';
      return 'green';
    default: return 'neutral';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Sparkline (inline SVG)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sparkline(values, stroke, w = 150, h = 30) {
  const nums = values
    .map(v => (v !== null && v !== undefined) ? parseFloat(v) : NaN)
    .filter(v => !isNaN(v));
  if (nums.length < 2) {
    return `<svg width="${w}" height="${h}">
      <text x="4" y="18" font-size="10" fill="#b8cdc5" font-family="sans-serif">â€”</text>
    </svg>`;
  }
  const min = Math.min(...nums), max = Math.max(...nums), range = max - min || 1;
  const pad = 3;
  const pts = nums.map((v, i) => {
    const x = pad + (i / (nums.length - 1)) * (w - pad * 2);
    const y = (h - pad) - ((v - min) / range) * (h - pad * 2) + pad / 2;
    return `${x.toFixed(1)},${y.toFixed(1)}`;
  }).join(' ');
  return `<svg width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
    <polyline points="${pts}" fill="none" stroke="${stroke}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
  </svg>`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Helpers
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function pad2(n) { return String(n).padStart(2, '0'); }

function formatTime(iso) {
  if (!iso) return 'â€”';
  const d = new Date(iso);
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())} ${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
}

function avgOf(arr) {
  const nums = arr.map(v => parseFloat(v)).filter(v => !isNaN(v));
  if (!nums.length) return null;
  return Math.round(nums.reduce((a, b) => a + b, 0) / nums.length);
}

function avgOfFloat(arr) {
  const nums = arr.map(v => parseFloat(v)).filter(v => !isNaN(v));
  if (!nums.length) return null;
  return (nums.reduce((a, b) => a + b, 0) / nums.length).toFixed(1);
}

function dateKey(iso) {
  if (!iso) return 'æœªçŸ¥';
  const d = new Date(iso);
  return `${d.getFullYear()}-${pad2(d.getMonth()+1)}-${pad2(d.getDate())}`;
}

function hourKey(iso) {
  if (!iso) return '00';
  return pad2(new Date(iso).getHours());
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Remember Me
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadRemembered() {
  const email = localStorage.getItem('rm_email');
  const pass  = localStorage.getItem('rm_pass');
  if (email) {
    document.getElementById('email').value = email;
    document.getElementById('remember').checked = true;
  }
  if (pass) {
    try { document.getElementById('password').value = atob(pass); } catch(e) {}
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Login
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doLogin() {
  const email    = document.getElementById('email').value.trim();
  const pass     = document.getElementById('password').value;
  const remember = document.getElementById('remember').checked;
  const errEl    = document.getElementById('login-error');
  const btn      = document.getElementById('btn-login');

  errEl.style.display = 'none';

  if (!email || !pass) {
    errEl.textContent = 'è«‹å¡«å¯« Email å’Œå¯†ç¢¼';
    errEl.style.display = 'block';
    return;
  }
  if (!ACCESS_MAP[email]) {
    errEl.textContent = 'æ­¤å¸³è™Ÿç„¡å­˜å–æ¬Šé™';
    errEl.style.display = 'block';
    return;
  }

  btn.disabled    = true;
  btn.textContent = 'ç™»å…¥ä¸­â€¦';

  const { data, error } = await sb.auth.signInWithPassword({ email, password: pass });

  if (error) {
    errEl.textContent   = 'ç™»å…¥å¤±æ•—ï¼š' + error.message;
    errEl.style.display = 'block';
    btn.disabled        = false;
    btn.textContent     = 'ç™»å…¥';
    return;
  }

  if (remember) {
    localStorage.setItem('rm_email', email);
    localStorage.setItem('rm_pass',  btoa(pass));
  } else {
    localStorage.removeItem('rm_email');
    localStorage.removeItem('rm_pass');
  }

  showDashboard(email);
}

document.addEventListener('keydown', e => {
  if (e.key === 'Enter' && document.getElementById('login-screen').style.display !== 'none') doLogin();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Logout  â† bug fixed: clears sb- keys & re-creates client
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doLogout() {
  await sb.auth.signOut({ scope: 'local' });

  // Purge all Supabase session data
  Object.keys(localStorage).forEach(k => {
    if (k.startsWith('sb-')) localStorage.removeItem(k);
  });

  // Fresh client so next signIn starts clean
  sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  currentTable = null;

  document.getElementById('dashboard').style.display    = 'none';
  document.getElementById('login-screen').style.display = 'flex';
  document.getElementById('btn-login').disabled    = false;
  document.getElementById('btn-login').textContent = 'ç™»å…¥';
  document.getElementById('login-error').style.display = 'none';

  loadRemembered();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Dashboard
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showDashboard(email) {
  document.getElementById('login-screen').style.display = 'none';
  document.getElementById('dashboard').style.display    = 'block';
  document.getElementById('user-email').textContent     = email;
  document.getElementById('user-avatar').textContent    = email[0].toUpperCase();
  document.getElementById('page-sub').textContent       = `å¸³è™Ÿï¼š${email}`;

  const tables = ACCESS_MAP[email] || [];
  const tabsEl = document.getElementById('tabs');
  tabsEl.innerHTML = '';

  tables.forEach((t, i) => {
    const btn = document.createElement('button');
    btn.className = 'tab' + (i === 0 ? ' active' : '');
    btn.innerHTML = `<span class="tab-dot"></span>${TABLE_LABEL[t] || t}`;
    btn.onclick   = () => switchTable(t, btn);
    tabsEl.appendChild(btn);
  });

  if (tables.length > 0) switchTable(tables[0], tabsEl.querySelector('.tab'));
}

function switchTable(name, btnEl) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  if (btnEl) btnEl.classList.add('active');
  currentTable = name;
  loadCurrentTable();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Load data
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadCurrentTable() {
  if (!currentTable) return;

  const content  = document.getElementById('table-content');
  const countEl  = document.getElementById('row-count');

  content.innerHTML        = '<div class="state-card"><span class="loading-spinner"></span>è¼‰å…¥ä¸­â€¦</div>';
  countEl.style.visibility = 'hidden';

  const { data, error } = await sb
    .from(currentTable)
    .select('*')
    .order('date_minute', { ascending: false })
    .limit(500);

  if (error) {
    content.innerHTML = `<div class="state-card">æŸ¥è©¢å¤±æ•—ï¼š${error.message}</div>`;
    return;
  }
  if (!data || data.length === 0) {
    content.innerHTML        = '<div class="state-card">æ­¤è³‡æ–™è¡¨ç›®å‰æ²’æœ‰è³‡æ–™</div>';
    countEl.style.visibility = 'visible';
    countEl.innerHTML        = 'å…± <strong>0</strong> ç­†';
    return;
  }

  countEl.style.visibility = 'visible';
  countEl.innerHTML = `é¡¯ç¤ºæœ€æ–° <strong>${data.length}</strong> ç­†`;

  renderGrouped(data, content);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Render: Date > Hour > Table
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderGrouped(data, container) {
  // Group data
  const byDate = {};
  data.forEach(row => {
    const dk = dateKey(row.date_minute);
    const hk = hourKey(row.date_minute);
    if (!byDate[dk])     byDate[dk]     = {};
    if (!byDate[dk][hk]) byDate[dk][hk] = [];
    byDate[dk][hk].push(row);
  });

  const dateKeys = Object.keys(byDate).sort((a, b) => b.localeCompare(a));
  container.innerHTML = '';

  // Build thead once
  let theadHtml = '<tr>';
  COLUMNS.forEach(c => { theadHtml += `<th>${c.label}</th>`; });
  theadHtml += '</tr>';

  dateKeys.forEach((date, di) => {
    const hours     = byDate[date];
    const hourKeys  = Object.keys(hours).sort((a, b) => b.localeCompare(a));
    const totalRows = hourKeys.reduce((s, hk) => s + hours[hk].length, 0);

    // â”€â”€ Hour Cards â”€â”€
    let hourCardsHtml = '';
    hourKeys.forEach((hk, hi) => {
      const rows  = hours[hk];
      const nextH = pad2(parseInt(hk) + 1);

      // Summary stats
      const avgHb   = avgOf(rows.map(r => r.heartbeat));
      const avgSbp  = avgOf(rows.map(r => r.sbp));
      const avgDbp  = avgOf(rows.map(r => r.dbp));
      const avgTemp = avgOfFloat(rows.map(r => r.temp).filter(v => v !== null));

      const hbLvl  = avgHb  ? anomalyLevel('heartbeat', avgHb)  : 'neutral';
      const sbpLvl = avgSbp ? anomalyLevel('sbp', avgSbp)       : 'neutral';

      const statsHtml = [
        avgHb   !== null ? `<div class="stat-chip"><span class="stat-icon">â¤ï¸</span><span class="stat-val${hbLvl  !== 'neutral' ? ' is-'+hbLvl  : ''}">${avgHb}</span></div>`   : '',
        avgSbp  !== null ? `<div class="stat-chip"><span class="stat-icon">ğŸ©º</span><span class="stat-val${sbpLvl !== 'neutral' ? ' is-'+sbpLvl : ''}">${avgSbp}</span></div>` : '',
        avgDbp  !== null ? `<div class="stat-chip"><span class="stat-icon">ğŸ’™</span><span class="stat-val">${avgDbp}</span></div>` : '',
        avgTemp !== null ? `<div class="stat-chip"><span class="stat-icon">ğŸŒ¡ï¸</span><span class="stat-val">${avgTemp}Â°C</span></div>` : '',
      ].join('');

      // Sparklines (oldest â†’ newest)
      const hbVals  = [...rows].reverse().map(r => r.heartbeat);
      const sbpVals = [...rows].reverse().map(r => r.sbp);
      const sparkHb  = sparkline(hbVals,  '#7aaa96');
      const sparkSbp = sparkline(sbpVals, '#bf7a45');

      // Table rows
      let tbodyHtml = '';
      rows.forEach(row => {
        tbodyHtml += '<tr>';
        COLUMNS.forEach(c => {
          const raw = row[c.key];
          let cell;
          if (raw === null || raw === undefined || raw === '') {
            cell = '<span class="val-dim">â€”</span>';
          } else if (c.key === 'date_minute' || c.key === 'received_at') {
            cell = `<span class="val-neutral">${formatTime(raw)}</span>`;
          } else if (c.badge) {
            const lvl     = anomalyLevel(c.key, raw);
            const display = c.key === 'temp' ? parseFloat(raw).toFixed(1) + 'Â°C' : raw;
            cell = lvl === 'neutral'
              ? `<span class="val-neutral">${display}</span>`
              : `<span class="val-badge val-${lvl}">${display}</span>`;
          } else {
            cell = `<span class="val-neutral">${raw}</span>`;
          }
          tbodyHtml += `<td>${cell}</td>`;
        });
        tbodyHtml += '</tr>';
      });

      // Auto-open first hour of first date
      const isOpen = (di === 0 && hi === 0) ? ' open' : '';

      hourCardsHtml += `
        <div class="hour-card${isOpen}">
          <div class="hour-header" onclick="this.parentElement.classList.toggle('open')">
            <div class="hour-label">${hk}:00 â€“ ${nextH}:00</div>
            <div class="hour-count">${rows.length} ç­†</div>
            <div class="hour-stats">${statsHtml}</div>
            <svg class="hour-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </div>
          <div class="hour-body">
            <div class="sparkline-area">
              <div class="spark-item">
                <div class="spark-label">å¿ƒè·³è¶¨å‹¢</div>
                ${sparkHb}
              </div>
              <div class="spark-item">
                <div class="spark-label">æ”¶ç¸®å£“è¶¨å‹¢</div>
                ${sparkSbp}
              </div>
            </div>
            <div class="data-table-wrap">
              <table class="data-table">
                <thead>${theadHtml}</thead>
                <tbody>${tbodyHtml}</tbody>
              </table>
            </div>
          </div>
        </div>`;
    });

    // â”€â”€ Date Card â”€â”€
    const dateEl = document.createElement('div');
    dateEl.className = 'date-card' + (di === 0 ? ' open' : '');
    dateEl.innerHTML = `
      <div class="date-header" onclick="this.parentElement.classList.toggle('open')">
        <div class="date-header-left">
          <div class="date-icon">ğŸ“…</div>
          <div>
            <div class="date-label">${date}</div>
            <div class="date-meta">${hourKeys.length} å€‹æ™‚æ®µãƒ»å…± ${totalRows} ç­†</div>
          </div>
        </div>
        <svg class="date-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
          <polyline points="6 9 12 15 18 9"/>
        </svg>
      </div>
      <div class="date-body">${hourCardsHtml}</div>
    `;
    container.appendChild(dateEl);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Init
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
loadRemembered();

(async () => {
  const { data: { session } } = await sb.auth.getSession();
  if (session?.user?.email && ACCESS_MAP[session.user.email]) {
    showDashboard(session.user.email);
  }
})();
</script>
</body>
</html>